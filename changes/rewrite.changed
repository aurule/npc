Complete rewrite of internal logic
